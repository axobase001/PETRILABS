# PETRILABS 安全审查报告

## 1. 单向门设计验证

### 定义
单向门：部署后**任何人**（包括部署者、平台、用户）都无法：
- 暂停Agent
- 修改Agent代码/逻辑
- 提取Agent资金
- 干预Agent决策

### 当前实现检查

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 合约无admin | ✅ | PetriAgentV2无admin函数 |
| 无暂停功能 | ✅ | 无pause/unpause |
| 资金锁定 | ✅ | 只能消耗，无法提取 |
| 私钥不落地 | ⚠️ | 需要改进生成方式 |
| 编排服务无干预 | ⚠️ | 需要验证 |

### 发现的问题

#### 问题1: 私钥生成方式不安全
**当前**: 私钥通过环境变量传入容器
**风险**: 可能在传输过程中泄露
**修复**: 在容器内生成，或一次性注入后立即清除

#### 问题2: 编排服务可能保留私钥副本
**当前**: 编排服务生成钱包后传递给容器
**风险**: 如果编排服务被攻击，私钥泄露
**修复**: 使用加密传输，或容器自行生成

#### 问题3: Akash/Arweave支付需要额外密钥
**当前**: 需要单独的Akash助记词和Arweave keyfile
**风险**: 用户体验不连贯，多密钥管理复杂
**修复**: 从单一EVM私钥派生或统一托管

---

## 2. 钱包生成与私钥安全

### 目标
- 私钥仅存在于Agent容器内存
- 私钥永不写入磁盘
- 私钥不经过任何中间服务
- 容器销毁 = 私钥永久丢失

### 推荐方案

#### 方案A: 容器内生成 (推荐)
```
1. 容器启动时生成新的EVM钱包
2. 公地址上报给工厂合约
3. 私钥仅存在于内存
4. 用户向该地址转账作为初始资金
```

**优点**: 最安全，私钥从未离开容器
**缺点**: 需要额外的资金转账步骤

#### 方案B: 编排服务生成并加密注入
```
1. 编排服务生成钱包
2. 使用一次性加密密钥加密私钥
3. 私钥仅通过加密通道传入容器
4. 容器解密后保留在内存
5. 加密密钥立即销毁
```

**优点**: 用户体验流畅
**缺点**: 私钥在传输过程中存在风险

---

## 3. 支付无感化检查

### 当前支付流程

#### LLM支付 (x402)
```
Agent → ainft.com(402) → 签名支付 → 使用服务
✅ 已实现，无需用户干预
```

#### Akash支付
```
当前: 需要手动部署，需要AKT或信用卡
问题: 不是无感支付
```

#### Arweave支付
```
当前: 需要keyfile和AR代币
问题: 不是无感支付
```

### 问题
Agent持有USDC，但：
- Akash需要AKT或法币支付
- Arweave需要AR代币
- 需要兑换或桥接机制

---

## 4. 预付费资源使用

### 当前设计

| 资源 | 预付费 | 实际使用方式 | 问题 |
|------|--------|-------------|------|
| LLM | 用户付API key | Agent用x402 | ✅ 已解决 |
| Akash | 用户付押金到Agent | 需要AKT支付 | ❌ 不匹配 |
| Arweave | 用户付AR到Agent | 需要AR支付 | ⚠️ 需要keyfile |

### 修复方案

#### Akash支付
**方案**: 使用Akash的x402支持或预付托管
```
1. 编排服务代表Agent预付费
2. 从Agent合约扣款USDC
3. 编排服务兑换为AKT并支付
```

#### Arweave支付
**方案**: 使用Irys（原Bundlr）的USDC支持
```
1. Agent使用Irys上传数据
2. Irys接受USDC支付
3. 无需AR代币，无需keyfile
```

---

## 5. 修复清单

### 高优先级
1. [ ] 实现安全的私钥生成方案
2. [ ] 集成Irys替代原生Arweave
3. [ ] 实现Akash USDC支付桥接
4. [ ] 移除编排服务的任何干预能力

### 中优先级
5. [ ] 添加私钥内存加密
6. [ ] 实现容器防调试机制
7. [ ] 添加私钥自毁机制

### 低优先级
8. [ ] 实现多签备份机制
9. [ ] 添加硬件安全模块(HSM)支持
