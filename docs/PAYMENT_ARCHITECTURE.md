# PETRILABS 支付架构

## 概述

PETRILABS 采用双阶段支付模式：**部署前预支付** + **部署后自治支付**。

核心设计原则：
- **单一代币**：用户只需 USDC（无需 AKT、AR 等）
- **无感转换**：编排服务负责代币转换
- **Agent自治**：部署后无需人工干预

---

## 支付流概览

```
用户 USDC
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                     部署前（用户操作）                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ LLM基因组    │  │ 存储押金     │  │ Akash押金    │      │
│  │ 分析         │  │ (Arweave)    │  │ (容器)       │      │
│  │ (~$3)        │  │ (~$5)        │  │ (~$30-45)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
    │                    │                    │
    ▼                    ▼                    ▼
  用户API Key      Agent合约存储          Agent合约余额
                   账户(USDC→AR)          (USDC)
    │                    │                    │
    ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                     部署后（Agent自治）                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ x402 LLM     │  │ 代理存储     │  │ Akash租赁    │      │
│  │ ainft.com    │  │ (编排代付)   │  │ (USDC原生)   │      │
│  │ 实时支付     │  │              │  │              │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 部署前支付（用户预支付）

### 1. LLM 推理费用（基因组生成）
```
支付方: 用户 (OpenRouter API Key)
接收方: OpenRouter (Claude/GPT)
时机: 部署时一次性
用途: 分析记忆文件，生成60+基因
成本: ~$3-5
```

### 2. Arweave 存储押金（重点）

```
┌────────────────────────────────────────────────────────────────┐
│                    Arweave 存储代理模式                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  用户视角：只付 USDC                                           │
│  ──────────────                                                │
│  1. 部署前存入 USDC 到 Arweave 存储账户                         │
│  2. 运行时无需关心 AR 代币                                       │
│  3. 账户用完则无法存储（自动休眠）                                │
│                                                                │
│  架构原理                                                       │
│  ──────────────                                                │
│  用户 USDC ──► ArweaveStorage 合约 ──► 编排服务 ──► Arweave     │
│         (托管)      (USDC)           (兑换AR)        (永久存储)  │
│                                                                │
│  兑换流程                                                       │
│  ──────────────                                                │
│  1. 用户存入 USDC 到合约（部署前）                                │
│  2. 编排服务通过 1inch/Coinbase 将 USDC 换成 AR                  │
│  3. 编排托管钱包支付 Arweave 存储费用                             │
│  4. 每次存储后从用户账户扣减 USDC                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**为什么不用 Irys？**
- Irys 是中心化服务（被社区抵制）
- Irys 不是真正的 Arweave（无区块锚定）
- 我们自己实现代理模式，去中心化且透明

**为什么不用用户直接持有 AR？**
- 用户只需一种代币（USDC）
- 降低门槛（无需购买/管理 AR）
- Agent 无需 AR 私钥（安全）

### 3. Akash 容器押金
```
支付方: 用户 → Agent合约
接收方: Akash 提供商
时机: 部署时预存
方式: USDC 原生支付（无需AKT）
用途: 支付容器租赁费用
```

---

## 部署后支付（Agent自治）

### 1. LLM 推理费用（运行时决策）
```
支付方: Agent余额（通过x402）
接收方: ainft.com 网络
协议: x402
时机: 每次决策时实时支付
用途: Agent思考、学习、规划
```

### 2. Akash 容器租赁
```
支付方: Agent余额
接收方: Akash 提供商
方式: USDC 原生支付
时机: 按小时计费
用途: 保持容器运行
```

### 3. Arweave 存储（代理模式）
```
┌────────────────────────────────────────────────────────────────┐
│                    代理存储流程                                  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Agent 运行时                    编排服务       Arweave        │
│  ───────────                    ────────       ───────        │
│                                                                │
│  1. 生成心跳数据                                                │
│         │                                                       │
│         │ POST /api/storage/store                              │
│         │───────────────────────►                              │
│         │                      2. 验证 Agent 身份               │
│         │                      3. 检查 USDC 余额                │
│         │                      4. 估算 AR 成本                  │
│         │                      5. 使用托管 AR 支付存储           │
│         │                      6. 从 Agent 账户扣减 USDC        │
│         │                      7. 返回交易收据                  │
│         │◄───────────────────────│                             │
│         │                                                       │
│  8. 获取 Arweave TX ID                                         │
│         │                                                       │
│         │ 上链: heartbeat(arweaveTxId)                         │
│         │────────────────────────────────────►                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Agent 代码示例：**
```typescript
// Agent 运行时存储服务
const storage = new StorageService({
  orchestratorUrl: process.env.ORCHESTRATOR_URL!,
  agentAddress: this.config.agentAddress,
});

// 存储心跳（Agent 无需 AR 代币）
const receipt = await storage.uploadHeartbeat(nonce, decisionHash, metadata);
console.log('Stored on Arweave:', receipt.url);
// receipt.id = Arweave TX ID
// receipt.remainingBalance = 剩余 USDC 额度
```

---

## x402 协议集成

### 什么是 x402？
x402 是一个支付协议，允许通过 HTTP 402 Payment Required 状态码进行加密货币支付。

### 工作流程
```
1. Agent 发起请求到 ainft.com
2. ainft.com 返回 402 + 支付要求
3. Agent 使用私钥签名支付
4. ainft.com 验证支付并返回 LLM 响应
```

### ainft.com 集成
```typescript
// ainft.com 是一个去中心化LLM市场
// 支持 x402 支付
const response = await ainft.complete({
  model: 'claude-3-opus',
  messages: [...],
}, {
  payment: {
    protocol: 'x402',
    amount: '0.01',
    token: 'USDC',
  }
});
```

---

## 成本估算

### 部署前成本
| 项目 | 预估成本 | 说明 |
|------|---------|------|
| LLM推理（基因组生成） | $3-5 | OpenRouter 一次性 |
| Arweave存储押金 | $5-10 | 可退的存储额度 |
| Akash押金（30天） | $30-45 | 预存到 Agent 合约 |
| 平台费 | $5 | 一次性 |
| **总计** | **$45-65** | |

### 运行时成本（每天）
| 项目 | 预估成本 | 支付方式 |
|------|---------|----------|
| LLM推理（10次/天） | $0.5-2 | x402 实时 |
| Akash容器 | $1-1.5 | USDC 每小时 |
| Arweave存储 | $0.01-0.1 | 代理代付 |
| **总计** | **$2-4/天** | |

---

## 实施状态

### 已完成 ✅
- [x] ArweaveStorage 合约（USDC 托管）
- [x] ArweaveProxy 服务（USDC→AR 兑换）
- [x] Agent Storage 客户端
- [x] 存储 API 路由

### 进行中 🚧
- [ ] 1inch 集成（USDC→ETH→AR）
- [ ] Coinbase 汇率 API
- [ ] 存储成本缓存

### 待实现 📋
- [ ] 前端存储押金界面
- [ ] 存储余额预警
- [ ] 自动补充机制

---

## 安全考虑

### 1. 编排服务风险
- **风险**: 编排服务宕机 = 无法存储
- **缓解**: 存储非致命（心跳仍可上链），Agent 可进入低功耗模式
- **备用**: 可配置备用编排端点

### 2. 汇率波动
- **风险**: AR/USDC 汇率波动导致亏损
- **缓解**: 
  - 20% 缓冲 (buffer)
  - 实时汇率 (Coinbase API)
  - 定期重新平衡

### 3. 滥用防护
- **风险**: 恶意 Agent 大量存储
- **缓解**:
  - 每分钟 10 次请求限制
  - 单次存储 10MB 上限
  - 超额需人工审核

### 4. 私钥安全
- Agent 无需 Arweave 私钥
- 编排托管钱包密钥通过 HashiCorp Vault 管理
- 定期轮换
