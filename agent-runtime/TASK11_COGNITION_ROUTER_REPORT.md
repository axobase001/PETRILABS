# ä»»åŠ¡ 11 å®ŒæˆæŠ¥å‘Šï¼šè®¤çŸ¥è·¯ç”±å™¨é‡æ„ï¼ˆåŸºå› é©±åŠ¨å†³ç­–ï¼‰

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

é‡æ„è®¤çŸ¥è·¯ç”±ç³»ç»Ÿï¼Œä»å›ºå®šçš„åŒæ¨¡æ€ï¼ˆå…è´¹+ä»˜è´¹ï¼‰å‡çº§ä¸ºåŸºäº**åŸºå› è¡¨è¾¾**å’Œ**ç»æµçŠ¶å†µ**çš„åŠ¨æ€ LLM æœåŠ¡é€‰æ‹©å™¨ã€‚å®ç°"åŸºå› å‹â†’è¡¨ç°å‹"çš„æ˜ å°„ï¼Œè®© Agent æ ¹æ®å…¶æ€§æ ¼ç‰¹è´¨è‡ªä¸»é€‰æ‹©è®¤çŸ¥æœåŠ¡ã€‚

---

## âœ… ä¿®æ”¹æ¸…å•

### 1. æ–°å»ºç±»å‹å®šä¹‰æ–‡ä»¶

**æ–‡ä»¶**: `src/cognition/types.ts`

å®šä¹‰æ ¸å¿ƒç±»å‹ï¼š
- `ProtocolType`: æœåŠ¡åè®®ç±»å‹ï¼ˆfree/x402/api_keyï¼‰
- `LLMProvider`: LLM æœåŠ¡å•†ç»“æ„
- `CognitiveTraits`: åŸºå› è¡¨è¾¾ï¼ˆè®¤çŸ¥ç‰¹è´¨ï¼‰
- `TaskCriticality`: ä»»åŠ¡å…³é”®æ€§çº§åˆ«
- `CognitiveResult`: è®¤çŸ¥ç»“æœ
- `ThinkRequest`: è®¤çŸ¥è¯·æ±‚
- `RoutingDecision`: è·¯ç”±å†³ç­–è®°å½•

### 2. æ–°å»º GeneRouter ç±»

**æ–‡ä»¶**: `src/cognition/gene-router.ts`

æ ¸å¿ƒåŠŸèƒ½ï¼š
- åŠ¨æ€æœåŠ¡å•†æ³¨å†Œè¡¨ï¼ˆæ”¯æŒè¿è¡Œæ—¶æ·»åŠ /ç§»é™¤ï¼‰
- åŸºå› é©±åŠ¨é€‰æ‹©ç®—æ³•ï¼ˆ4 ç§ç­–ç•¥åˆ†æ”¯ï¼‰
- æ”¯æŒ free/x402/api_key ä¸‰ç§åè®®
- æœåŠ¡è´¨é‡è‡ªè¯„ä¼°ï¼ˆEMA æŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼‰
- ç»æµæ„ŸçŸ¥ï¼ˆå®æ—¶ä½™é¢æ£€æŸ¥ï¼‰

### 3. æ›´æ–°è®¤çŸ¥æ¨¡å—å¯¼å‡º

**æ–‡ä»¶**: `src/cognition/index.ts`

æ–°å¢å¯¼å‡ºï¼š
- `GeneRouter`: åŸºå› é©±åŠ¨è·¯ç”±å™¨ï¼ˆé»˜è®¤å¯¼å‡ºï¼‰
- æ‰€æœ‰ç±»å‹å®šä¹‰
- å‘åå…¼å®¹ï¼šä¿ç•™ä¼ ç»Ÿ `CognitionRouter`

### 4. æ–°å»ºæµ‹è¯•æ–‡ä»¶

**æ–‡ä»¶**: `src/cognition/__tests__/gene-router.test.ts`

æµ‹è¯•è¦†ç›–ï¼š
- æœåŠ¡å•†ç®¡ç†
- 4 ç§åŸºå› é©±åŠ¨ç­–ç•¥
- ç»æµæ„ŸçŸ¥ï¼ˆä½™é¢æ£€æŸ¥ï¼‰
- è‡ªè¯„ä¼°ä¸å­¦ä¹ ï¼ˆEMAï¼‰
- è¾¹ç•Œæƒ…å†µ
- 3 ä¸ªç¤ºä¾‹åœºæ™¯

---

## ğŸ§¬ åŸºå› é©±åŠ¨é€‰æ‹©ç®—æ³•

### å†³ç­–æ ‘

```
å¼€å§‹é€‰æ‹©
    â”‚
    â”œâ”€â”€ ç­–ç•¥ 1: æç«¯èŠ‚ä¿­æ¨¡å¼ â”€â”€â†’ savingsTendency > 0.8 æˆ–ä½™é¢ < 2 USDC
    â”‚                            â†“
    â”‚                         é€‰å…è´¹æœåŠ¡å•†ï¼ˆæˆ–æœ€ä¾¿å®œçš„ï¼‰
    â”‚
    â”œâ”€â”€ ç­–ç•¥ 2: é«˜å±å†³ç­–æ¨¡å¼ â”€â”€â†’ critical + ä½™é¢ > 5 USDC
    â”‚                            â†“
    â”‚                         cognitionQuality > 0.7? 
    â”‚                            â”œâ”€â”€ YES â†’ é€‰æœ€å¥½ä»˜è´¹æœåŠ¡
    â”‚                            â””â”€â”€ NO  â†’ é€‰æœ€å¯é æœåŠ¡
    â”‚
    â”œâ”€â”€ ç­–ç•¥ 3: é£é™©åŒæ¶æ¨¡å¼ â”€â”€â†’ riskAppetite < 0.3
    â”‚                            â†“
    â”‚                         é€‰æˆåŠŸç‡æœ€é«˜çš„
    â”‚
    â””â”€â”€ ç­–ç•¥ 4: é»˜è®¤ç­–ç•¥ â”€â”€â”€â”€â”€â”€â†’ æ€§ä»·æ¯”å¹³è¡¡
                                 â†“
                              score = (quality Ã— successRate) / cost
```

### åŸºå› ç‰¹è´¨å½±å“

| ç‰¹è´¨ | é«˜å€¼è¡¨ç° | ä½å€¼è¡¨ç° |
|------|----------|----------|
| **savingsTendency** | æç«¯èŠ‚ä¿­ï¼Œä¼˜å…ˆå…è´¹ | èŠ±é’±å¦‚æµæ°´ |
| **cognitionQuality** | è¿½æ±‚æœ€å¥½ï¼Œæ„¿æ„ä»˜è´¹ | èƒ½ç”¨å°±è¡Œ |
| **riskAppetite** | å†’é™©å°è¯•æ–°æœåŠ¡ | ä¿å®ˆé€‰å¯é çš„ |
| **cooperationTendency** | å€¾å‘ç¤¾åŒºå…è´¹æœåŠ¡ | å€¾å‘å•†ä¸šæœåŠ¡ |

---

## ğŸ“Š é»˜è®¤æœåŠ¡å•†é…ç½®

```typescript
// å…è´¹å±‚
{
  id: 'pollinations',
  protocol: 'free',
  costPer1kTokens: 0,
  qualityScore: 0.6,
}

// ä»˜è´¹å±‚
{
  id: 'daydreams-x402',
  protocol: 'x402',
  costPer1kTokens: 0.01,
  minBalanceRequired: 0.1,
  qualityScore: 0.85,
}
```

---

## ğŸ”„ è‡ªè¯„ä¼°ä¸å­¦ä¹ æœºåˆ¶

### EMA æ›´æ–°å…¬å¼

```typescript
const alpha = 0.1; // å¹³æ»‘å› å­

// æˆåŠŸæ—¶
successRate = successRate * 0.9 + 0.1;
avgLatency = avgLatency * 0.9 + newLatency * 0.1;
qualityScore = qualityScore * 0.9 + newQuality * 0.1;

// å¤±è´¥æ—¶
successRate = successRate * 0.9; // è¡°å‡
consecutiveFailures++;

// è¿ç»­ 3 æ¬¡å¤±è´¥ â†’ æ ‡è®°ä¸ºä¸å¯ç”¨
if (consecutiveFailures >= 3) available = false;
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

```
src/cognition/
â”œâ”€â”€ types.ts                  âœ… æ ¸å¿ƒç±»å‹å®šä¹‰
â”œâ”€â”€ gene-router.ts            âœ… åŸºå› é©±åŠ¨è·¯ç”±å™¨
â”œâ”€â”€ index.ts                  âœ… æ›´æ–°å¯¼å‡º
â”œâ”€â”€ router.ts                 âœ… ä¿ç•™ï¼ˆå‘åå…¼å®¹ï¼‰
â”œâ”€â”€ providers/                âœ… ä¿ç•™
â”‚   â”œâ”€â”€ pollinations.ts
â”‚   â””â”€â”€ x402-llm.ts
â”œâ”€â”€ __tests__/
â”‚   â””â”€â”€ gene-router.test.ts   âœ… æµ‹è¯•æ–‡ä»¶
â””â”€â”€ ...
```

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºç¡€ä½¿ç”¨

```typescript
import { GeneRouter } from './cognition';

const router = new GeneRouter({
  wallet: agentWallet,
  traits: {
    riskAppetite: 0.5,
    savingsTendency: 0.3,
    cognitionQuality: 0.8,
    cooperationTendency: 0.6,
    stressResponse: 'adaptive',
  },
});

// æ‰§è¡Œè®¤çŸ¥
const result = await router.think({
  prompt: 'åˆ†æå¸‚åœºè¶‹åŠ¿...',
  context: workingMemory,
  criticality: 'high',
});

console.log(result.provider, result.cost, result.content);
```

### åŠ¨æ€æ·»åŠ æœåŠ¡å•†

```typescript
router.registerProvider({
  id: 'my-provider',
  name: 'Custom LLM',
  endpoint: 'https://llm.example.com',
  protocol: 'x402',
  costPer1kTokens: 0.02,
  qualityScore: 0.9,
  // ...
});
```

### è¿è¡Œæ—¶è°ƒæ•´ç‰¹è´¨

```typescript
// Agent ç»å†å‹åŠ›äº‹ä»¶åå˜å¾—æ›´ä¿å®ˆ
router.updateTraits({ 
  riskAppetite: 0.2,
  stressResponse: 'conservative',
});
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

| ç±»åˆ« | ç”¨ä¾‹æ•° | å†…å®¹ |
|------|--------|------|
| æœåŠ¡å•†ç®¡ç† | 4 | æ³¨å†Œã€æ³¨é”€ã€æŸ¥è¯¢ |
| åŸºå› é€‰æ‹© | 12 | 4 ç§ç­–ç•¥ + è¾¹ç•Œæƒ…å†µ |
| ç»æµæ„ŸçŸ¥ | 3 | ä½™é¢æ£€æŸ¥ã€è´Ÿæ‹…èƒ½åŠ› |
| è‡ªè¯„ä¼°å­¦ä¹  | 5 | EMA æ›´æ–°ã€å¤±è´¥å¤„ç† |
| ç‰¹è´¨ç®¡ç† | 2 | æ›´æ–°ã€æ‹·è´ |
| å†³ç­–å†å² | 2 | è®°å½•ã€é™åˆ¶ |
| ç¤ºä¾‹åœºæ™¯ | 3 | èŠ‚ä¿­ã€é«˜è´¨ã€é£é™©åŒæ¶ |

**æ€»è®¡ï¼š31 ä¸ªæµ‹è¯•ç”¨ä¾‹**

---

## ğŸ”— ä¸åç»­ä»»åŠ¡çš„å…³è”

| ä»»åŠ¡ | å…³è”ç‚¹ |
|------|--------|
| **ä»»åŠ¡ 12ï¼ˆæœ¬èƒ½æ¨¡å¼ï¼‰** | `selectProvider` è¿”å› null æ—¶è§¦å‘ `NoProviderAvailableError`ï¼Œè¿›å…¥æœ¬èƒ½æ¨¡å¼ |
| **ä»»åŠ¡ 16ï¼ˆå·¥ä½œè®°å¿†ï¼‰** | `think()` æ–¹æ³•æ¥æ”¶ `WorkingMemory` ä½œä¸º context |
| **ä»»åŠ¡ 20ï¼ˆx402 å‘ç°ï¼‰** | åŠ¨æ€æ·»åŠ æ–°å‘ç°çš„ x402 æœåŠ¡å•†åˆ° `providers Map` |

---

## âœ… éªŒæ”¶æ ‡å‡†æ£€æŸ¥

- [x] `GeneRouter` ç±»å®Œæ•´å®ç°ï¼Œæ”¯æŒåŠ¨æ€ provider æ³¨å†Œ
- [x] åŸºå› é©±åŠ¨é€‰æ‹©ç®—æ³•å®ç°ï¼ˆ4 ç§ç­–ç•¥åˆ†æ”¯ï¼‰
- [x] æ”¯æŒ free/x402/api_key ä¸‰ç§åè®®
- [x] æœåŠ¡è´¨é‡è‡ªè¯„ä¼°æœºåˆ¶ï¼ˆqualityScore/successRate EMA æ›´æ–°ï¼‰
- [x] ä¸åŸºå› ç»„ trait çš„é›†æˆæ¥å£
- [x] å®Œå–„çš„é”™è¯¯å¤„ç†ï¼ˆ`NoProviderAvailableError`ï¼‰
- [x] æµ‹è¯•è¦†ç›–ä¸»è¦é€‰æ‹©é€»è¾‘ï¼ˆ31 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

---

## ğŸ‰ ä»»åŠ¡å®Œæˆ

**çŠ¶æ€**: âœ… å®Œæˆ

**æ ¸å¿ƒç›®æ ‡è¾¾æˆ**:
1. âœ… å¯æ‰©å±•çš„ LLM æœåŠ¡å•†æ³¨å†Œè¡¨ï¼ˆåŠ¨æ€å‘ç°ï¼‰
2. âœ… åŸºå› é©±åŠ¨é€‰æ‹©ç®—æ³•ï¼ˆ4 ç§ç­–ç•¥åˆ†æ”¯ï¼‰
3. âœ… æ”¯æŒå…è´¹ã€x402 ä»˜è´¹ã€API Key ä¸‰ç§åè®®
4. âœ… æœåŠ¡è´¨é‡è‡ªè¯„ä¼°ä¸åŠ¨æ€æ›´æ–°
5. âœ… ç»æµæ„ŸçŸ¥ï¼ˆå®æ—¶ä½™é¢æ£€æŸ¥ï¼‰
6. âœ… å®Œæ•´æµ‹è¯•è¦†ç›–ï¼ˆ31 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

**æ¶æ„ä»·å€¼**:
- Agent æ‹¥æœ‰"æ€§æ ¼"ï¼Œæ ¹æ®å…¶åŸºå› è¡¨è¾¾åšå‡ºä¸åŒå†³ç­–
- ç»æµçº¦æŸä¸è®¤çŸ¥è´¨é‡ä¹‹é—´çš„åŠ¨æ€å¹³è¡¡
- è‡ªå­¦ä¹ èƒ½åŠ›ï¼ˆæœåŠ¡è´¨é‡ EMA æ›´æ–°ï¼‰
- ä¸åç»­æœ¬èƒ½æ¨¡å¼ã€å·¥ä½œè®°å¿†ã€x402 å‘ç°æ— ç¼é›†æˆ
